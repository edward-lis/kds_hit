
    Протокол обмена с КДС ХИТ vers 10 ... 22.01.2016

Сокращения:
    УУТББ - Унифицированное Устройство Телеметрии Бортовых Батарей
    НРИ   - Номер Режима Измерения по № п/п "Таблица_режимов_исправл.xls" и
            НРИ "Таб Коммт КДС-AGN W-x.odt"
                                     
  БАТ    N ЦЕПЕЙ     
--------------------
  9ER14P-24  .
  9ЕR14PS-24 . УУТББ 
  9ER20P-20  . УУТББ
  9ER20P-28  .
                  
 Структура Байт/Символьной Датаграммы для обмена
с КДС ХИТ через виртуальный COM port - 115200 8N1:
--------------------------------------------------
Pref Pref Cod  Len  B  B
0xFF;0xFF;0x08;4 ?; ?; ?;NMC;CRC;
      ГДЕ:
;   - Разделитель байтов и цепочек байтов в этом тексте
?   - Заполняется Посылающей стороной 
P   - PREFIX / ПРЕФИКС   
C   - CODE / КОД Операции
L   - LENGTH / Количество ОСТАВШИХСЯ Байт в Датаграмме - ВКЛЮЧАЯ CRC
B   - Собственно Данные Byte/BODY , до 240 Байт.   
NMC - Обязательный N УСТРОЙСТВА: 7 для БИП(Блока Измерения Параметров) !
CRC - Простая сумма ПРЕДЫДУЩИХ байт - НАЧИНАЯ с CODE  
    ОБЯЗАТЕЛЬНО СОБЛЮДАТЬ в BODY Шрифт WIN(1251), РЕГИСТР и ПОЗИЦИЮ КЛЮЧЕВЫХ
слов/шаблонов. Допустимо четное выравнивание BODY символами СПРАВА
но с учетом в LENGTH и CRC !

НРИ - Номер Режима Измерения в Баблице Коммутации !
                         
    При включении Устройство приводится в Режим IDLE - все
коммутации сбрасываются ! !
    КОМАНДУ IDLE можно не давать вначале сеанса, если была ранее(окончанием
предыдущего) но для окончания или досрочного прекращения ЛЮБОГО режима - обязательно.

0xFF;0xFF;0x08;7;"IDLE#";7;CRC; - СТОП Режима влечёт
Ответ:
0xAA;0xAA;0x08;9;"IDLE#OK";7;CRC;

    Внутренний TIMEOUT/ТАЙМАУТ - переводит УСТРОЙСТВО в IDLE в Режиме НЗЦ
и зависит от тока нагрузки:
  При токе 0.1 А <= (15 мин + 5 сек)
  При токе 0.5 А <= ( 5 мин + 5 сек)
  При токе 1.0 А <= ( 1 мин + 5 сек)
                                                       
    КОМАНДА PING доступна всегда, но лучше в пассивном/IDLE режиме устройста.
0xFF;0xFF;0x01;28;"ЛюБые ByTeS, до 240 штук !";7;CRC; - Влечет,
  взависимости от длины, не позже 30mS ПОСЛЕ ПРИЕМА, ОТВЕТ:
0xAA;0xAA;0x01;28;"ЛюБые ByTeS, до 240 штук !";7;CRC;

    После КОМАНДЫ ПУСК Режима первую КОМАНДУ ОПРОС/ЗАПРОС подавать не ранее
чем через 400 mS ,это связано с коммутацией режима , даже если
подтверждение коммутации пришло быстро. Последующие КОМАНДЫ ОПРОС/ЗАПРОС
можно подавать с интервалом в 270 mS.
    КОМАНДУ IDLE можно подавать вне очереди. После IDLE - следующий
режим выбирать не ранее чем 150 mS 

    В теле КОМАНДЫ для КДС ХИТ, в символьной его части , применять
символ # - для отделения значимой/ключевой части от необязательной.

    УУТББ - Унифицированное Устройство Телеметрии Бортовых Батарей
    НРИ   - Номер Режима Измерения


    Для определения Типа батареи выполнить секцию "PolarB#"
затем по результату:
- при прямой   полярности т.е. предположении 9ER20P-20 или 9ER20P-28 выполнить
  секцию "TipeB gr#" где gr=28, если в результате 9ER20P-28(без УУТББ) будет
  исключена(при отсутствии напряжении) то остаётся 9ER20P-20 и для неё
  выполнить секцию "UocPB#", если есть напряжение блока питания УУТББ значит
  УУТББ присутствует !
- при обратной полярности т.е. предположении 9ER14P-24 или 9ЕR14PS-24
  выполнить секцию "UocPB#", если есть напряжение блока питания УУТББ значит
  УУТББ присутствует !



-). НРИ 001: Определение Полярности Батареи !
0xFF;0xFF;0x08; 9;"PolarB#";7;CRC;         Команда
0xAA;0xAA;0x08;11;"PolarB#OK";7;CRC;       Подтверждение
0xFF;0xFF;0x08;10;"PolarB?#";7;CRC;        Запрос
0xAA;0xAA;0x08;17;hl;"   #PolarB OK";7;CRC; Ответ hl=0(прямая: 9ER20P-20 или
  9ER20P-28);1(обратная: 9ER14P-24 или 9ЕR14PS-24; т.е. полярность будет
  REVERS/перевёрнута включением и удержанием реле К1) и будет храниться до конца
  проверок или обновления этой же командой !


-). НРИ 002: Определение Подтипа Батареи ! Поочереди ЗАПРОСИТЬ:
 gr=28 затем gr=24 (номер крайней группы),кто первым ответит кодом ПРИЛИЧНОГО
                 Напряжения - значит ОНО и ЕСТЬ ! иначе остаётся gr=20 групп !
0xFF;0xFF;0x08;11;"TipeB gr#";7;CRC;        Команда
0xAA;0xAA;0x08;13;"TipeB gr#OK";7;CRC;      Подтверждение
0xFF;0xFF;0x08; 9;"TipeB?#";7;CRC;          Запрос
0xAA;0xAA;0x08;18;hl;"   #TipeB grOK";7;CRC; Ответ hl=КОД U


-). НРИ 003-4: ПРОВЕРКА Опорного Напряжения АЦП1 и АЦП2
                  КОМАНДЫ(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;    - СТОП Режима

0xFF;0xFF;0x08;10;"Uref#";7;CRC;    - ПУСК  , ОТВЕТ:
0xAA;0xAA;0x08; 9;"Uref#OK";7;CRC;  - Подтверждение

0xFF;0xFF;0x08; 8;"Uref?#";7;CRC;   - ЗАПРОС U referens/опоры Влечет:
ОТВЕТ(ВАРИАНТЫ):
0xAA;0xAA;0x08;22;hl;" ";hl;"#Uref OK475 480";7;CRC; - hl hl - Код Опоры АЦП1 и АЦП2 !
0xAA;0xAA;0x08; 8;"ERROR#";7;CRC;    - Не выбран режим(например !)



-). НРИ 005,9-12,18-108; Rins 00-96: ПРОВЕРКА Сопротивления Изоляции 
        Rизoл/Rins(insulation Resistance)
  Все Rins Режимы/коммутации последовательно нумерованы: nn[00 по 96]

"Rins 00#" Сопротивление(MOm) ОБРАЗЦОВОГО резистора 
  
                  КОМАНДА(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;        - СТОП Режима

0xFF;0xFF;0x08;10;"Rins nn#";7;CRC;     - ПУСК Rins в Режиме nn, по готовности
коммутации влечет ОТВЕТ:
0xAA;0xAA;0x08;12;"Rins nn#OK";7;CRC;

0xFF;0xFF;0x08; 8;"Rins?#";7;CRC;       - ОПРОС Rins, Влечет:
ОТВЕТ(ВАРИАНТЫ):
0xAA;0xAA;0x08;17;hl;"   #Rins nnOK";7;CRC; - hl U16 КОД АЦП Rизол 



-). НРИ 013: ПРОВЕРКА Напряжения Разомкнутой/Ненагруженной цепи группы ( 01-:-28 )
  НРЦг/(open-circuit voltage Group)/UocG батареи.
  ПРИ U 32.8±0.5 V продолжать в авторежиме.  При U < 32.3 V стоп до
  команды оператора. 
                  КОМАНДЫ(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;      - СТОП Режима (Здесь НРЦг !)

0xFF;0xFF;0x08;10;"UocG gg#";7;CRC;   - ПУСК/ТЕСТ НРЦг gg группы, влечет ОТВЕТ:
0xAA;0xAA;0x08;12;"UocG gg#OK";7;CRC; - Подтверждение: НРЦг gg группы

0xFF;0xFF;0x08; 8;"UocG?#";7;CRC;       - ОПРОС текущего НРЦг Влечет:
ОТВЕТ(ВАРИАНТЫ):
0xAA;0xAA;0x08;18;hl;"   #UocG gg OK";7;CRC; - НРЦг U=32.70V
0xAA;0xAA;0x08; 8;"ERROR#";7;CRC;       - Не выбран режим(например !)
-------------------------------------------------------------------


-). НРИ 006: *ПРОВЕРКА Напряжения Разомкнутой/Ненагруженной цепи
  (НРЦб)/(open-circuit voltage battery)/(UocB) батареи.
  ПРИ U 32.8±0.5 V продолжать в авторежиме. При U < 32.3 V стоп до
  команды оператора.
                  КОМАНДЫ(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;      - СТОП Режима

0xFF;0xFF;0x08; 7;"UocB#";7;CRC;      - ПУСК/ТЕСТ НРЦб батареи, влечет ОТВЕТ:
0xAA;0xAA;0x08; 9;"UocB#OK";7;CRC;    - ЗАПУЩЕН РЕЖИМ: НРЦб

0xFF;0xFF;0x08; 8;"UocB?#";7;CRC;     - ОПРОС НРЦб Влечет:
ОТВЕТ(ВАРИАНТЫ):
0xAA;0xAA;0x08;15;hl;"   #UocB OK";7;CRC; - hl U16 COD АЦП НРЦб
0xAA;0xAA;0x08; 8;"ERROR#";7;CRC;
---------------------------------


-). НРИ 007-8:  ПРОВЕРКА Напряжения на Корпусе, не более 3V !
                            КОМАНДЫ(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;      - СТОП Режима

0xFF;0xFF;0x08; 9;"Ucase+#";7;CRC;    - Команда или
0xFF;0xFF;0x08; 9;"Ucase-#";7;CRC;    - Команда влечёт соответственно:
0xAA;0xAA;0x08;11;"Ucase+#OK";7;CRC;  - Подтверждение или
0xAA;0xAA;0x08;11;"Ucase-#OK";7;CRC;  - Подтверждение
0xFF;0xFF;0x08; 9;"Ucase?#";7;CRC;    - ОПРОС 
ОТВЕТ
0xAA;0xAA;0x08;16;hl;"   #Ucase+OK";7;CRC; - hl U16 COD АЦП


-). НРИ 015-17: Проверка Напряжения замк. группы ( 01-:-28 )
токами .1A,.5A,1.0A; Код тока i=[1,2,3] - на время не более 15,5 и 1 Мин
                  КОМАНДЫ(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;        - СТОП Режима

0xFF;0xFF;0x08;12;"UccG gg i#";7;CRC;   - ПУСК группы, током i
влечёт ОТВЕТ:
0xAA;0xAA;0x08;14;"UccG gg i#OK";7;CRC; - Подтверждение
                                           
0xFF;0xFF;0x08; 8;"UccG?#";7;CRC;       - ЗАПРОС Напряжения Влечет:
ОТВЕТ
0xAA;0xAA;0x08;18;hl;"   UccG gg iOK";7;CRC; - U16 hl=COD U, i Код тока 


-). НРИ 014: ПРОВЕРКА Напряжения Замкнутой/Нагруженной ЦЕПИ батареи
НЗЦб/(closed-circuit voltage battary)/UccB , при токе i=3 ==> 1.0 A
При несоответствии заданным параметрамм - стоп до команды оператора.
                  КОМАНДЫ(ВАРИАНТЫ):
0xFF;0xFF;0x08; 7;"IDLE#";7;CRC;     - СТОП Режима

0xFF;0xFF;0x08; 7;"UccB#";7;CRC;     - ПУСК НЗЦб , ОТВЕТ:
0xAA;0xAA;0x08; 9;"UccB#OK";7;CRC;   - ЗАПУЩЕН РЕЖИМ - НЗЦб батареи
0xFF;0xFF;0x08; 8;"UccB?#";7;CRC;    - ОПРОС НЗЦб Влечет:
ОТВЕТ(ВАРИАНТЫ):
0xAA;0xAA;0x08;15;hl;"   #UccB OK";7;CRC; - U16 hl=COD U






-). НРИ 109: Напряжение Блока Питания платы УТБ 
0xFF;0xFF;0x08; 8;"UocPB#";7;CRC;         Команда
0xAA;0xAA;0x08;10;"UocPB#OK";7;CRC;       Подтверждение
0xFF;0xFF;0x08; 9;"UocPB?#";7;CRC;        Запрос
0xAA;0xAA;0x08;16;hl"   #UocPB OK";7;CRC; Ответ


-). НРИ 110: Напряжение Блока Питания платы УТБ Нагруженого
0xFF;0xFF;0x08; 8;"UccPB#";7;CRC;        Команда
0xAA;0xAA;0x08;10;"UccPB#OK";7;CRC;      Подтверждение
0xFF;0xFF;0x08; 9;"UccPB?#";7;CRC;       Запрос 
0xAA;0xAA;0x08;16;hl;"   #UccPB OK";7;CRC;   Ответ


-). НРИ 111: Контроль Телеметр.ПАРалл код - Состояние Порта A
0xFF;0xFF;0x08; 9;"TlmPar#";7;CRC;        Команда
0xAA;0xAA;0x08;11;"TlmPar#OK";7;CRC;      Подтверждение
0xFF;0xFF;0x08;10;"TlmPar?#";7;CRC;       Запрос
0xAA;0xAA;0x08;15;hl;" #TlmPar OK";7;CRC; Ответ hl U16 Код из
  оставить/сделать Коммутацию Техно.Заглушки (вкл питания УУТББ) Х6 ???

-). НРИ 112: Контроль Телеметр.ПОСлед код - Принят от USART1
0xFF;0xFF;0x08; 9;"TlmSer#";7;CRC;        Команда
0xAA;0xAA;0x08;11;"TlmSer#OK";7;CRC;      Подтверждение
0xFF;0xFF;0x08;10;"TlmSer?#";7;CRC;       Запрос
0xAA;0xAA;0x08;15;hl;" #TlmSer OK";7;CRC; Ответ hl U16 Код
  оставить/сделать Коммутацию Техно.Заглушки (вкл питания УУТББ) Х6 ???


-). НРИ 113: Имитация Техно.Заглушки Х6
0xFF;0xFF;0x08; 9;"StubX6#";7;CRC;      Команда
0xAA;0xAA;0x08;11;"StubX6#OK";7;CRC;    Подтверждение


 
Таблица 5 - Номера контактов для проверки сопротивления
изоляции платы измерительной     батареи 9ER20P-20
          Номер контакта соединителя
==========================================================
     корпус        | Rins 05-16 | 1-4,6-9,11,13-15(Х5 "5")
   1(Х3 "3-")      |      17-28 | 1-4,6-9,11,13-15(Х5 "5")
   1(Х1 "1+")      |      29-40 | 1-4,6-9,11,13-15(Х5 "5")
Перемыч.6(Х1 "1+") |      41-52 | 1-4,6-9,11,13-15(Х5 "5")
Перемыч.7(Х1 "1+") |      53-64 | 1-4,6-9,11,13-15(Х5 "5")
----------------------------------------------------------
   1(Х3 "3-")      |      65-70 |     1,2,3,4,9,10(Х6 "6")
   1(Х1 "1+")      |      71-76 |     1,2,3,4,9,10(Х6 "6")
Перемыч.6(Х1 "1+") |      77-82 |     1,2,3,4,9,10(Х6 "6")
Перемыч.7(Х1 "1+") |      83-88 |     1,2,3,4,9,10(Х6 "6")
     корпус	       |      89-94 |     1,2,3,4,9,10(Х6 "6")
==========================================================


Таблица 6 - Номера контактов для проверки сопротивления
изоляции "Rins" платы измерительной     батареи 9ER14PS-24
          Номер контакта соединителя
==========================================================
     корпус        | Rins 05-16 | 1-4,6-9,11,13-15(Х5 "5")
   1(Х1 "111-")    |      17-28 | 1-4,6-9,11,13-15(Х5 "5")
   1(Х2 "+112")    |      29-40 | 1-4,6-9,11,13-15(Х5 "5")
   1(Х1 "111-")    |      65-70 |     1,2,3,4,9,10(Х6 "6")
   1(Х2 "+112")    |      71-76 |     1,2,3,4,9,10(Х6 "6")
     корпус        |      89-94 |     1,2,3,4,9,10(Х6 "6")
==========================================================


mailto:lis007@mail.ru
mailto:edward.lisovtsev@gmail.com

mailto:aiva1959@yandex.ru


